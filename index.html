<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Railway Professional Training Portal</title>

    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" href="192x192.png">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Railway Trg">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Embedded Manifest for "Add to Home Screen" capability -->
    <link rel="manifest" id="manifest-placeholder">
    <script>
        // Dynamically generating manifest to ensure it works as a Data URI
        // resolving the local image path relative to the current page location
        const localIconUrl = new URL('192x192.png', window.location.href).toString();

        const manifest = {
            "name": "Railway Professional Training",
            "short_name": "Railway Trg",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#166534",
            "orientation": "portrait",
            "icons": [
                {
                    "src": localIconUrl,
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": localIconUrl,
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a', 
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        indigo: {
                            50: '#eef2ff',
                            600: '#4f46e5',
                            900: '#312e81',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f9fafb; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        // --- ASSETS ---
        // Updated to use the local file
        const KAVACH_LOGO_URL = "192x192.png"; 

        // --- DATA ---
        const TOPICS_DATA = [
            {
                id: 'kavach',
                title: "KAVACH System (Technical)",
                subtitle: "Automatic Train Protection Syllabus",
                description: "Master the indigenous Train Collision Avoidance System (TCAS) components, fail-safe architecture, and operational procedures.",
                thumbnail: "shield-check", 
                color: "bg-brand-600",
                locked: false, 
                progress: 0
            },
            {
                id: 'operating',
                title: "Transportation (Operating)",
                subtitle: "G&SR and Block Working",
                description: "The core curriculum for Guards and Station Masters. Covers General & Subsidiary Rules (G&SR) and Safe Block Working procedures.",
                thumbnail: "route",
                color: "bg-orange-600",
                locked: true, 
                progress: 0
            },
            {
                id: 'commercial',
                title: "Commercial",
                subtitle: "Ticket Checking & Passenger Amenities",
                description: "Training modules for Commercial Clerks/Ticket Examiners (TCs). Focuses on revenue protection, fare rules, and customer service standards.",
                thumbnail: "ticket",
                color: "bg-red-600",
                locked: true, 
                progress: 0
            },
            {
                id: 'personnel',
                title: "Establishment (Personnel)",
                subtitle: "D&A Rules, Leave Rules, Rajbhasha",
                description: "Essential training for all railway employees covering Discipline & Appeal (D&A) Rules, Leave entitlements, and the official language policy.",
                thumbnail: "users",
                color: "bg-blue-600",
                locked: true, 
                progress: 0
            }
        ];

        const KAVACH_MODULES = [
            {
                id: 1,
                title: "KAVACH Fundamentals & SIL-4 Safety",
                duration: "15:00",
                url: "https://youtu.be/L9SMgB5QNOs", 
                description: "Defining KAVACH objectives (SPAD, collision, speed control). Understanding the concepts of Safety Integrity Level (SIL) and how KAVACH achieves SIL-4 compliance.",
                resources: [
                    { title: "RDSO TCAS Specification V1.2", url: "https://www.google.com/search?q=RDSO+TCAS+Specification+SIL4+pdf" },
                    { title: "Safety Case Report Summary", url: "https://www.google.com/search?q=Kavach+Safety+Case+Summary+IRICEN" }
                ]
            },
            {
                id: 2,
                title: "Loco-side Equipment (OBD/DMI)",
                duration: "18:30",
                url: "https://youtu.be/9_rOF6GrQr8",
                description: "Detailed study of the On-Board Display (OBD) and Driver Machine Interface (DMI). Interpretation of cab signaling, speed indicators, target distance bar, and audio-visual alerts in the loco cabin.",
                resources: [
                    { title: "DMI Operations Manual", url: "https://www.google.com/search?q=Kavach+DMI+User+Guide+pdf" }
                ]
            },
            {
                id: 3,
                title: "Trackside Architecture & RFID Tags",
                duration: "14:10",
                url: "https://youtu.be/JsokzsfFFmk",
                description: "Placement and function of trackside equipment. Focus on RFID tags for absolute positioning, including installation standards and maintenance checks of the trackside unit.",
                resources: [
                    { title: "RFID Tag Installation Checklist", url: "https://www.google.com/search?q=RDSO+Kavach+RFID+installation+manual" },
                    { title: "Trackside Unit Maintenance Guide", url: "https://www.google.com/search?q=Kavach+Trackside+Maintenance+Protocol" }
                ]
            },
            {
                id: 4,
                title: "UHF Radio Communication Network",
                duration: "12:00",
                url: "https://youtu.be/MDHElMgya4k",
                description: "The communication backbone. Explaining the UHF channel allocation, data packet structure, and the communication protocol between the Station TCAS, Loco TCAS, and Repeater Stations.",
                resources: [
                    { title: "UHF Frequency & Protocol Document", url: "https://www.google.com/search?q=Kavach+UHF+Communication+Standard" }
                ]
            },
            {
                id: 5,
                title: "Speed Monitoring & Dynamic Braking Curve",
                duration: "20:45",
                url: "https://youtu.be/5882emtXmag",
                description: "The core safety algorithm. How KAVACH calculates the permissible speed, target speed, and the dynamic braking curve based on gradient, train characteristics, and distance to the next signal/restriction.",
                resources: [
                    { title: "Braking Curve Calculation Logic", url: "https://www.google.com/search?q=TCAS+Dynamic+Braking+Curve+Algorithm" }
                ]
            },
            {
                id: 6,
                title: "Operational Scenarios: SPAD & Temporary Restrictions",
                duration: "10:30",
                url: "https://youtu.be/JuvA7ONSUvw",
                description: "Handling critical situations: KAVACH intervention during Signal Passed at Danger (SPAD), running under temporary speed restrictions (TSR), and navigating loop lines/turnouts safely.",
                resources: [
                    { title: "SPAD Event Analysis Guidelines", url: "https://www.google.com/search?q=Kavach+SPAD+Handling+Procedure" }
                ]
            },
            {
                id: 7,
                title: "Troubleshooting & Maintenance Procedures",
                duration: "16:50",
                url: "https://youtu.be/k3CuRhH7Q-g",
                description: "Standard troubleshooting for Loco TCAS and Station TCAS faults. Procedures for daily checks, periodical maintenance (PMC), and fault logging.",
                resources: [
                    { title: "KAVACH Fault Finding Manual", url: "https://www.google.com/search?q=Kavach+Troubleshooting+and+Maintenance+Guide" }
                ]
            }
        ];

        // --- ICONS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            React.useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- HOOK: PERSISTENT STATE ---
        // This hook automatically saves 'value' to localStorage whenever it changes
        const usePersistentState = (key, initialValue) => {
            const [state, setState] = React.useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error("Error reading from localStorage", error);
                    return initialValue;
                }
            });

            React.useEffect(() => {
                try {
                    window.localStorage.setItem(key, JSON.stringify(state));
                } catch (error) {
                    console.error("Error writing to localStorage", error);
                }
            }, [key, state]);

            return [state, setState];
        };

        // --- COMPONENT: CUSTOM MODAL ---
        const CustomModal = ({ isOpen, onClose, title, message, iconName }) => {
            if (!isOpen) return null;

            return (
                <div 
                    className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"
                    onClick={onClose}
                >
                    <div 
                        className="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="p-6">
                            <div className="flex items-start">
                                <div className="flex-shrink-0">
                                    <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                                        <Icon name={iconName} size={20} />
                                    </div>
                                </div>
                                <div className="ml-4 pt-1">
                                    <h3 className="text-lg font-bold text-gray-900">{title}</h3>
                                    <p className="mt-1 text-sm text-gray-500">{message}</p>
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 shadow-md transition-colors"
                                >
                                    Got it
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: TOPIC CARD ---
        const TopicCard = ({ topic, onSelect, completedCount }) => {
            // Calculate progress if it's the Kavach course
            let progress = 0;
            if (topic.id === 'kavach') {
                progress = Math.round((completedCount / KAVACH_MODULES.length) * 100);
            }

            return (
                <div 
                    onClick={() => onSelect(topic)}
                    className={`bg-white rounded-2xl shadow-sm border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group relative overflow-hidden ${topic.locked ? 'opacity-80' : ''}`}
                >
                    {topic.locked && (
                        <div className="absolute top-4 right-4 bg-gray-100 p-2 rounded-full text-gray-400 z-10">
                            <Icon name="lock" size={16} />
                        </div>
                    )}

                    <div className={`w-14 h-14 rounded-2xl ${topic.color} flex items-center justify-center text-white mb-6 shadow-lg transform group-hover:scale-110 transition-transform duration-300`}>
                        <Icon name={topic.thumbnail} size={28} />
                    </div>

                    <h3 className="text-xl font-bold text-gray-900 mb-1 group-hover:text-brand-600 transition-colors">{topic.title}</h3>
                    <p className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">{topic.subtitle}</p>
                    <p className="text-gray-600 text-sm leading-relaxed mb-6">{topic.description}</p>

                    {/* Progress Bar for Active Courses */}
                    {!topic.locked && progress > 0 && (
                        <div className="mb-4">
                            <div className="flex justify-between text-xs font-semibold text-gray-500 mb-1">
                                <span>Progress</span>
                                <span>{progress}%</span>
                            </div>
                            <div className="w-full bg-gray-100 rounded-full h-1.5">
                                <div className="bg-brand-500 h-1.5 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>
                    )}

                    <div className="flex items-center justify-between mt-auto">
                        <span className={`text-sm font-medium ${topic.locked ? 'text-gray-400' : 'text-brand-600'}`}>
                            {topic.locked ? 'Coming Soon' : (progress > 0 ? 'Continue Learning' : 'Start Learning')}
                        </span>
                        {!topic.locked && <Icon name="arrow-right" size={16} className="text-brand-600 transform group-hover:translate-x-1 transition-transform" />}
                    </div>
                </div>
            );
        };

        // --- COMPONENT: DASHBOARD ---
        const Dashboard = ({ onSelectCourse, completedModules }) => {
            return (
                <div className="flex flex-col min-h-screen bg-gray-50">
                    {/* Main Header */}
                    <header className="bg-brand-800 text-white pt-10 pb-10 px-4 sm:px-8 shadow-xl relative overflow-hidden shrink-0">
                        <div className="absolute top-0 right-0 w-96 h-96 bg-white opacity-5 rounded-full -mr-20 -mt-20 pointer-events-none"></div>
                        <div className="absolute bottom-0 left-0 w-64 h-64 bg-black opacity-10 rounded-full -ml-20 -mb-20 pointer-events-none"></div>

                        <div className="max-w-7xl mx-auto flex justify-between items-center relative z-10">
                            <div className="flex items-center space-x-4">
                                <div>
                                    <h1 className="text-3xl sm:text-4xl font-bold tracking-tight">Railway Professional Training Portal</h1>
                                    <p className="text-brand-100 mt-2 text-lg font-medium">Curriculum Focused on Indian Railways Operations</p>
                                </div>
                            </div>

                            <div className="hidden sm:block">
                                <img 
                                    src={KAVACH_LOGO_URL} 
                                    className="h-20 w-20 rounded-xl bg-white/10 p-2 object-contain backdrop-blur-sm border border-white/20" 
                                    alt="Platform Logo"
                                    onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/80x80/4F46E5/ffffff?text=IR'; }}
                                />
                            </div>
                        </div>
                    </header>

                    {/* Content Grid */}
                    <main className="flex-1 px-4 sm:px-8 py-8 max-w-7xl mx-auto w-full z-20">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate-fade-in">
                            {TOPICS_DATA.map((topic) => (
                                <TopicCard 
                                    key={topic.id} 
                                    topic={topic} 
                                    onSelect={onSelectCourse} 
                                    completedCount={topic.id === 'kavach' ? completedModules.length : 0}
                                />
                            ))}
                        </div>

                        <div className="mt-12 text-center pb-8">
                            <p className="text-gray-500 text-sm">Â© 2025 Railway Training Resource. Unofficial Learning Material.</p>
                            <p className="text-gray-400 text-xs mt-2">App Version 2.1 (PWA Enabled)</p>
                        </div>
                    </main>
                </div>
            );
        };

        // --- COMPONENT: SIDEBAR ---
        const Sidebar = ({ modules, activeModuleId, onSelectModule, completedModules, isOpen, toggleSidebar, onBack }) => {
            return (
                <div className={`fixed inset-y-0 left-0 z-30 w-80 bg-gray-900 text-gray-300 transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col shadow-2xl border-r border-gray-800`}>

                    <div className="p-4 border-b border-gray-800 bg-gray-900/50 backdrop-blur-sm">
                        <button 
                            onClick={onBack}
                            className="flex items-center text-gray-400 hover:text-white mb-4 transition-colors group"
                        >
                            <Icon name="arrow-left" size={16} className="mr-2 group-hover:-translate-x-1 transition-transform" />
                            <span className="text-sm font-medium">Back to Dashboard</span>
                        </button>

                        <div className="flex items-center space-x-3">
                            <div className="bg-brand-600 p-2 rounded-lg shadow-lg shadow-brand-900/50">
                                <Icon name="shield-check" className="text-white" size={20} />
                            </div>
                            <span className="text-lg font-bold text-white tracking-tight">KAVACH TCAS</span>
                        </div>
                    </div>

                    <div className="px-6 py-4 border-b border-gray-800 bg-gray-800/30">
                        <div className="flex justify-between text-xs font-bold uppercase tracking-wider text-gray-500 mb-2">
                            <span>Progress</span>
                            <span>{Math.round((completedModules.length / modules.length) * 100)}%</span>
                        </div>
                        <div className="w-full bg-gray-800 rounded-full h-1.5 overflow-hidden">
                            <div 
                                className="bg-brand-500 h-1.5 rounded-full transition-all duration-700 ease-out shadow-[0_0_10px_rgba(34,197,94,0.5)]" 
                                style={{ width: `${(completedModules.length / modules.length) * 100}%` }}
                            ></div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-1">
                        {modules.map((module, index) => {
                            const isActive = module.id === activeModuleId;
                            const isCompleted = completedModules.includes(module.id);

                            return (
                                <button 
                                    key={module.id}
                                    onClick={() => onSelectModule(module.id)}
                                    className={`w-full text-left p-3 rounded-lg transition-all duration-200 group flex items-start space-x-3 ${isActive ? 'bg-brand-900/40 border border-brand-500/30 shadow-inner' : 'hover:bg-gray-800 border border-transparent'}`}
                                >
                                    <div className="mt-1 flex-shrink-0">
                                        {isActive ? (
                                            <div className="w-5 h-5 rounded-full bg-brand-500 flex items-center justify-center animate-pulse shadow-lg shadow-brand-500/40">
                                                <Icon name="play" size={10} className="text-white fill-current" />
                                            </div>
                                        ) : isCompleted ? (
                                            <div className="w-5 h-5 rounded-full bg-emerald-500/20 text-emerald-500 flex items-center justify-center border border-emerald-500/30">
                                                <Icon name="check" size={12} />
                                            </div>
                                        ) : (
                                            <div className="w-5 h-5 rounded-full border-2 border-gray-700 group-hover:border-gray-500 text-xs flex items-center justify-center text-gray-600 font-mono">
                                                {index + 1}
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className={`text-sm font-medium truncate ${isActive ? 'text-white' : 'text-gray-400 group-hover:text-gray-200'}`}>
                                            {module.title}
                                        </p>
                                        <div className="flex items-center mt-1 text-xs text-gray-600 space-x-2">
                                            <Icon name="clock" size={10} />
                                            <span>{module.duration} min</span>
                                        </div>
                                    </div>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const VideoPlayer = ({ url, title }) => {
            const getEmbedUrl = (rawUrl) => {
                if (rawUrl.includes('youtu.be/')) {
                    const id = rawUrl.split('youtu.be/')[1];
                    return `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1`;
                }
                return rawUrl;
            };

            return (
                <div className="w-full aspect-video bg-black rounded-xl overflow-hidden shadow-2xl relative group ring-1 ring-gray-900/5">
                    <iframe 
                        src={getEmbedUrl(url)}
                        className="w-full h-full"
                        frameBorder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowFullScreen
                    ></iframe>
                </div>
            );
        };

        // --- COMPONENT: COURSE PLAYER (Updated for Persistence) ---
        const CoursePlayer = ({ onBack, completedModules, setCompletedModules }) => {
            const [activeModuleId, setActiveModuleId] = React.useState(1);
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
            const [activeTab, setActiveTab] = React.useState('overview');
            
            // Notes Persistence
            const [allNotes, setAllNotes] = usePersistentState('kavach_user_notes', {});
            const [currentNote, setCurrentNote] = React.useState('');

            const activeModule = KAVACH_MODULES.find(m => m.id === activeModuleId);

            // Sync current note when module changes
            React.useEffect(() => {
                setCurrentNote(allNotes[activeModuleId] || '');
            }, [activeModuleId, allNotes]);

            // Save note handler
            const handleNoteChange = (e) => {
                const newText = e.target.value;
                setCurrentNote(newText);
                setAllNotes(prev => ({
                    ...prev,
                    [activeModuleId]: newText
                }));
            };

            const handleModuleSelect = (id) => {
                setActiveModuleId(id);
                setIsSidebarOpen(false);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const toggleComplete = () => {
                if (completedModules.includes(activeModuleId)) {
                    setCompletedModules(prev => prev.filter(id => id !== activeModuleId));
                } else {
                    setCompletedModules(prev => [...prev, activeModuleId]);
                }
            };

            const nextModule = () => {
                const currentIndex = KAVACH_MODULES.findIndex(m => m.id === activeModuleId);
                if (currentIndex < KAVACH_MODULES.length - 1) {
                    if (!completedModules.includes(activeModuleId)) {
                        setCompletedModules(prev => [...prev, activeModuleId]);
                    }
                    handleModuleSelect(KAVACH_MODULES[currentIndex + 1].id);
                }
            };

            const prevModule = () => {
                const currentIndex = KAVACH_MODULES.findIndex(m => m.id === activeModuleId);
                if (currentIndex > 0) {
                    handleModuleSelect(KAVACH_MODULES[currentIndex - 1].id);
                }
            };

            return (
                <div className="flex h-screen bg-white">
                    {isSidebarOpen && (
                        <div className="fixed inset-0 bg-black/50 z-20 md:hidden backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)}></div>
                    )}

                    <Sidebar 
                        modules={KAVACH_MODULES}
                        activeModuleId={activeModuleId}
                        onSelectModule={handleModuleSelect}
                        completedModules={completedModules}
                        isOpen={isSidebarOpen}
                        toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)}
                        onBack={onBack}
                    />

                    <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                        <div className="md:hidden bg-white border-b p-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                            <div className="flex items-center space-x-3">
                                <button onClick={() => setIsSidebarOpen(true)} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                                    <Icon name="menu" />
                                </button>
                                <span className="font-bold text-gray-800">KAVACH Module {activeModuleId}</span>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar bg-gray-50/50">
                            <div className="max-w-5xl mx-auto">
                                <div className="flex items-center space-x-2 text-xs font-semibold uppercase tracking-wider text-gray-500 mb-4">
                                    <span onClick={onBack} className="cursor-pointer hover:text-brand-600 transition-colors">Courses</span>
                                    <Icon name="chevron-right" size={12} />
                                    <span>KAVACH System</span>
                                </div>

                                <VideoPlayer url={activeModule.url} title={activeModule.title} />

                                <div className="mt-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                    <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-6 border-b border-gray-100 pb-6 mb-6">
                                        <div>
                                            <h1 className="text-2xl font-bold text-gray-900">{activeModule.title}</h1>
                                            <div className="flex items-center mt-2 space-x-4">
                                                <span className="px-2.5 py-0.5 rounded-full bg-brand-50 text-brand-700 text-xs font-bold border border-brand-100">Module {activeModule.id}</span>
                                                <span className="text-sm text-gray-500 flex items-center">
                                                    <Icon name="clock" size={14} className="mr-1" /> {activeModule.duration}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="flex items-center space-x-3">
                                            <button onClick={prevModule} disabled={activeModuleId === 1} className="p-2.5 rounded-xl border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"><Icon name="chevron-left" /></button>

                                            <button onClick={toggleComplete} className={`flex-1 sm:flex-none flex items-center justify-center space-x-2 px-6 py-2.5 rounded-xl border font-semibold transition-all duration-200 ${completedModules.includes(activeModuleId) ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-gray-200 text-gray-700 hover:border-gray-300 hover:bg-gray-50'}`}>
                                                <Icon name={completedModules.includes(activeModuleId) ? "check-circle" : "circle"} size={18} />
                                                <span>{completedModules.includes(activeModuleId) ? "Completed" : "Mark Done"}</span>
                                            </button>

                                            <button onClick={nextModule} disabled={activeModuleId === KAVACH_MODULES.length} className="p-2.5 rounded-xl bg-brand-600 text-white hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-brand-600/20 transition-all"><Icon name="chevron-right" /></button>
                                        </div>
                                    </div>

                                    {/* Tabs */}
                                    <div className="flex space-x-8 border-b border-gray-100 mb-6">
                                        {['Overview', 'Resources', 'Notes'].map((tab) => (
                                            <button key={tab} onClick={() => setActiveTab(tab.toLowerCase())} className={`pb-3 text-sm font-semibold border-b-2 transition-all duration-200 ${activeTab === tab.toLowerCase() ? 'border-brand-600 text-brand-600' : 'border-transparent text-gray-500 hover:text-gray-800'}`}>{tab}</button>
                                        ))}
                                    </div>

                                    <div className="min-h-[200px] animate-fade-in">
                                        {activeTab === 'overview' && (
                                            <div>
                                                <p className="text-gray-600 leading-relaxed text-lg">{activeModule.description}</p>
                                                <div className="mt-8 bg-brand-50 rounded-xl p-6 border border-brand-100">
                                                    <h4 className="font-bold text-brand-800 mb-3 flex items-center"><Icon name="lightbulb" size={18} className="mr-2 text-brand-600" />Learning Objectives</h4>
                                                    <ul className="space-y-2.5 text-brand-900/80 text-sm">
                                                        <li className="flex items-start"><span className="mr-2.5 mt-1.5 w-1.5 h-1.5 bg-brand-500 rounded-full"></span><span>Articulate the necessity of Automatic Train Protection (ATP) systems in high-density corridors.</span></li>
                                                        <li className="flex items-start"><span className="mr-2.5 mt-1.5 w-1.5 h-1.5 bg-brand-500 rounded-full"></span><span>Accurately identify and describe the function of all Loco-side and Trackside components.</span></li>
                                                        <li className="flex items-start"><span className="mr-2.5 mt-1.5 w-1.5 h-1.5 bg-brand-500 rounded-full"></span><span>Simulate and respond correctly to critical system alerts and brake interventions.</span></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        )}
                                        {activeTab === 'resources' && (
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                {activeModule.resources.map((res, idx) => (
                                                    <a 
                                                        key={idx} 
                                                        href={res.url} 
                                                        target="_blank" 
                                                        rel="noopener noreferrer"
                                                        className="p-4 rounded-xl border border-gray-200 hover:border-brand-300 hover:bg-brand-50/30 transition-all cursor-pointer group flex items-center justify-between no-underline"
                                                    >
                                                        <div className="flex items-center space-x-3">
                                                            <div className="bg-gray-100 p-2.5 rounded-lg group-hover:bg-white text-gray-500 group-hover:text-brand-600 transition-colors"><Icon name="file-text" size={20} /></div>
                                                            <div>
                                                                <p className="font-semibold text-gray-900">{res.title}</p>
                                                                <p className="text-xs text-gray-500 mt-0.5">Search Official Docs</p>
                                                            </div>
                                                        </div>
                                                        <Icon name="external-link" size={18} className="text-gray-400 group-hover:text-brand-600" />
                                                    </a>
                                                ))}
                                            </div>
                                        )}
                                         {activeTab === 'notes' && (
                                            <div className="bg-gray-50 p-6 rounded-xl border border-gray-200">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className="text-gray-900 font-bold flex items-center">
                                                        <Icon name="pen-tool" size={18} className="mr-2 text-brand-600" /> 
                                                        Personal Notes
                                                    </h3>
                                                    <span className="text-xs text-gray-500 bg-white border px-2 py-1 rounded-md shadow-sm">Auto-saving...</span>
                                                </div>
                                                <textarea 
                                                    className="w-full h-40 p-4 rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all text-sm leading-relaxed"
                                                    placeholder="Type your observations or key takeaways here..."
                                                    value={currentNote}
                                                    onChange={handleNoteChange}
                                                ></textarea>
                                                <p className="mt-2 text-xs text-gray-500">Notes are stored locally on your device for this module.</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [currentView, setCurrentView] = React.useState('dashboard'); 
            const [selectedCourseId, setSelectedCourseId] = React.useState(null);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [modalContent, setModalContent] = React.useState({});
            
            // GLOBAL PERSISTENCE
            const [completedModules, setCompletedModules] = usePersistentState('kavach_progress', []);

            const handleSelectCourse = (course) => {
                if (course.locked) {
                    setModalContent({
                        title: `${course.title} Syllabus Locked`,
                        message: `The '${course.title}' curriculum is currently under development to align with the latest training guidelines. Please check back later or start with the functional 'KAVACH System' course.`,
                        iconName: "lock"
                    });
                    setIsModalOpen(true);
                    return;
                }

                if (course.id === 'kavach') {
                    setSelectedCourseId('kavach');
                    setCurrentView('course');
                }
            };

            const handleBackToDashboard = () => {
                setCurrentView('dashboard');
                setSelectedCourseId(null);
            };

            return (
                <React.Fragment>
                    {currentView === 'dashboard' ? (
                        <Dashboard 
                            onSelectCourse={handleSelectCourse} 
                            completedModules={completedModules}
                        />
                    ) : (
                        <CoursePlayer 
                            onBack={handleBackToDashboard} 
                            completedModules={completedModules}
                            setCompletedModules={setCompletedModules}
                        />
                    )}

                    <CustomModal 
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        title={modalContent.title}
                        message={modalContent.message}
                        iconName={modalContent.iconName}
                    />
                </React.Fragment>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

